const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const fs = require('fs');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
    cors: {
        origin: "*",
        methods: ["GET", "POST"]
    }
});

// Middleware
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

// –§–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
const USERS_FILE = 'users.json';
const CHATS_FILE = 'chats.json';
const RATINGS_FILE = 'ratings.json';

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–æ–≤
function loadData(filename, defaultValue = []) {
    try {
        if (fs.existsSync(filename)) {
            const data = fs.readFileSync(filename, 'utf8');
            return JSON.parse(data);
        }
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}:`, error);
    }
    return defaultValue;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª—ã
function saveData(filename, data) {
    try {
        fs.writeFileSync(filename, JSON.stringify(data, null, 2));
        console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ ${filename}`);
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ${filename}:`, error);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
let users = loadData(USERS_FILE, []);
let chats = loadData(CHATS_FILE, []);
let ratings = loadData(RATINGS_FILE, []);

// –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
const demoUsers = [
    {
        id: '1',
        username: 'user',
        password: '123456',
        role: 'user',
        displayName: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        rating: 0,
        ratingCount: 0,
        isOnline: false
    },
    {
        id: '2', 
        username: 'listener',
        password: '123456',
        role: 'listener',
        displayName: '–ê–Ω–Ω–∞ –°–ª—É—à–∞—Ç–µ–ª—å',
        rating: 4.8,
        ratingCount: 15,
        isOnline: false
    },
    {
        id: '3',
        username: 'admin',
        password: 'admin123', 
        role: 'admin',
        displayName: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –°–∏—Å—Ç–µ–º—ã',
        rating: 5.0,
        ratingCount: 8,
        isOnline: false
    }
];

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
demoUsers.forEach(demoUser => {
    const exists = users.find(u => u.username === demoUser.username);
    if (!exists) {
        users.push(demoUser);
    }
});
saveData(USERS_FILE, users);

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
function generateId() {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}

// Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
io.on('connection', (socket) => {
    console.log(`üîó –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${socket.id}`);

    // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò
    socket.on('restore_session', (data) => {
        const user = users.find(u => u.id === data.userId);
        if (user) {
            user.isOnline = true;
            user.socketId = socket.id;
            saveData(USERS_FILE, users);
            
            socket.emit('session_restored', { user });
            socket.emit('users_list', { users: users.filter(u => u.id !== user.id) });
            socket.emit('chats_list', { chats });
            socket.emit('ratings_list', { ratings });
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            socket.broadcast.emit('user_connected', { user });
            console.log(`üîÑ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${user.username}`);
        }
    });

    // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
    socket.on('register', (data) => {
        const { username, password, role } = data;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const existingUser = users.find(u => u.username === username);
        if (existingUser) {
            socket.emit('registration_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const newUser = {
            id: generateId(),
            username,
            password, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å!
            role: role || 'user',
            displayName: username,
            rating: 0,
            ratingCount: 0,
            isOnline: true,
            socketId: socket.id,
            createdAt: new Date()
        };

        users.push(newUser);
        saveData(USERS_FILE, users);
        
        socket.emit('registration_success');
        socket.broadcast.emit('user_connected', { user: newUser });
        console.log(`‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}`);
    });

    // –í–•–û–î
    socket.on('login', (data) => {
        const { username, password } = data;
        
        const user = users.find(u => u.username === username && u.password === password);
        if (!user) {
            socket.emit('login_error', '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.isOnline = true;
        user.socketId = socket.id;
        saveData(USERS_FILE, users);

        socket.emit('login_success', { user });
        socket.emit('users_list', { users: users.filter(u => u.id !== user.id) });
        socket.emit('chats_list', { chats });
        socket.emit('ratings_list', { ratings });
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        socket.broadcast.emit('user_connected', { user });
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥: ${username}`);
    });

    // –°–û–ó–î–ê–ù–ò–ï –ß–ê–¢–ê
    socket.on('create_chat', (data) => {
        const { user1, user2 } = data;
        
        const user1Data = users.find(u => u.id === user1);
        const user2Data = users.find(u => u.id === user2);
        
        if (!user1Data || !user2Data) {
            socket.emit('chat_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        const newChat = {
            id: generateId(),
            user1,
            user2, 
            messages: [],
            startTime: new Date(),
            isActive: true
        };

        chats.push(newChat);
        saveData(CHATS_FILE, chats);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Ç –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        socket.emit('chat_created', { 
            chat: newChat, 
            listenerName: user2Data.displayName 
        });
        
        const listenerSocket = io.sockets.sockets.get(user2Data.socketId);
        if (listenerSocket) {
            listenerSocket.emit('chat_created', { 
                chat: newChat, 
                listenerName: user1Data.displayName 
            });
        }

        console.log(`üí¨ –ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω: ${user1Data.username} ‚Üî ${user2Data.username}`);
    });

    // –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
    socket.on('send_message', (data) => {
        const { chatId, message } = data;
        
        const chat = chats.find(c => c.id === chatId);
        if (!chat) {
            socket.emit('message_error', '–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        if (!chat.messages) chat.messages = [];
        
        const newMessage = {
            id: generateId(),
            text: message.text,
            senderId: message.senderId,
            timestamp: new Date()
        };

        chat.messages.push(newMessage);
        saveData(CHATS_FILE, chats);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞
        const user1 = users.find(u => u.id === chat.user1);
        const user2 = users.find(u => u.id === chat.user2);

        socket.emit('new_message', { chatId, message: newMessage });
        
        const targetUser = message.senderId === chat.user1 ? user2 : user1;
        if (targetUser && targetUser.socketId) {
            const targetSocket = io.sockets.sockets.get(targetUser.socketId);
            if (targetSocket) {
                targetSocket.emit('new_message', { chatId, message: newMessage });
            }
        }

        console.log(`üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ ${chatId}`);
    });

    // –û–¶–ï–ù–ö–ê –°–õ–£–®–ê–¢–ï–õ–Ø
    socket.on('submit_rating', (data) => {
        const { listenerId, rating, comment, userId } = data;
        
        const newRating = {
            id: generateId(),
            listenerId,
            userId,
            rating,
            comment,
            timestamp: new Date()
        };

        ratings.push(newRating);
        saveData(RATINGS_FILE, ratings);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ —Å–ª—É—à–∞—Ç–µ–ª—è
        const listenerRatings = ratings.filter(r => r.listenerId === listenerId);
        const totalRating = listenerRatings.reduce((sum, r) => sum + r.rating, 0);
        const avgRating = totalRating / listenerRatings.length;

        const listener = users.find(u => u.id === listenerId);
        if (listener) {
            listener.rating = avgRating;
            listener.ratingCount = listenerRatings.length;
            saveData(USERS_FILE, users);
        }

        socket.emit('rating_submitted', {
            listenerId,
            newRating: avgRating,
            ratingCount: listenerRatings.length
        });

        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—è –æ–± –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ
        if (listener && listener.socketId) {
            const listenerSocket = io.sockets.sockets.get(listener.socketId);
            if (listenerSocket) {
                listenerSocket.emit('rating_submitted', {
                    listenerId,
                    newRating: avgRating, 
                    ratingCount: listenerRatings.length
                });
            }
        }

        console.log(`‚≠ê –ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Å–ª—É—à–∞—Ç–µ–ª—è ${listenerId}: ${rating} –∑–≤–µ–∑–¥`);
    });

    // –ó–ê–í–ï–†–®–ï–ù–ò–ï –ß–ê–¢–ê
    socket.on('end_chat', (chatId) => {
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            chat.isActive = false;
            chat.endTime = new Date();
            saveData(CHATS_FILE, chats);

            // –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞
            io.emit('chat_ended', { chatId });
            console.log(`üö™ –ß–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${chatId}`);
        }
    });

    // –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê
    socket.on('register_staff', (data) => {
        const { username, password, displayName, role } = data;
        
        const existingUser = users.find(u => u.username === username);
        if (existingUser) {
            socket.emit('staff_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        const newStaff = {
            id: generateId(),
            username,
            password,
            role,
            displayName,
            rating: 0,
            ratingCount: 0,
            isOnline: false,
            createdAt: new Date()
        };

        users.push(newStaff);
        saveData(USERS_FILE, users);

        socket.emit('staff_added', { user: newStaff });
        console.log(`‚ûï –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ${username} (${role})`);
    });

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï –†–û–õ–ò
    socket.on('change_role', (data) => {
        const { userId, newRole } = data;
        
        const user = users.find(u => u.id === userId);
        if (user) {
            user.role = newRole;
            saveData(USERS_FILE, users);

            socket.emit('role_changed', { userId, newRole });
            console.log(`üé≠ –†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞: ${user.username} -> ${newRole}`);
        }
    });

    // –ó–ê–ü–†–û–° –î–ê–ù–ù–´–•
    socket.on('get_users', () => {
        socket.emit('users_list', { users });
    });

    socket.on('get_chats', () => {
        socket.emit('chats_list', { chats });
    });

    socket.on('get_ratings', () => {
        socket.emit('ratings_list', { ratings });
    });

    // –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï
    socket.on('disconnect', () => {
        console.log(`üîå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ: ${socket.id}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = users.find(u => u.socketId === socket.id);
        if (user) {
            user.isOnline = false;
            user.socketId = null;
            saveData(USERS_FILE, users);
            
            socket.broadcast.emit('user_disconnected', { userId: user.id });
            console.log(`üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è: ${user.username}`);
        }
    });
});

// –ú–∞—Ä—à—Ä—É—Ç—ã API
app.get('/api/users', (req, res) => {
    res.json(users);
});

app.get('/api/chats', (req, res) => {
    res.json(chats);
});

app.get('/api/ratings', (req, res) => {
    res.json(ratings);
});

app.get('/api/stats', (req, res) => {
    const stats = {
        totalUsers: users.length,
        totalListeners: users.filter(u => u.role === 'listener').length,
        activeChats: chats.filter(c => c.isActive).length,
        onlineUsers: users.filter(u => u.isOnline).length
    };
    res.json(stats);
});

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`);
    console.log(`üí¨ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Ç–æ–≤: ${chats.length}`);
    console.log(`‚≠ê –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Ü–µ–Ω–æ–∫: ${ratings.length}`);
});
