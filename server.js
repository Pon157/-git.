const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const fs = require('fs');
const cors = require('cors');

const app = express();
const server = http.createServer(app);

const io = socketIo(server, {
    cors: {
        origin: "*",
        methods: ["GET", "POST"]
    }
});

// Middleware
app.use(cors());
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// –§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö
const DATA_DIR = './data';
const USERS_FILE = path.join(DATA_DIR, 'users.json');
const CHATS_FILE = path.join(DATA_DIR, 'chats.json');
const RATINGS_FILE = path.join(DATA_DIR, 'ratings.json');
const NOTIFICATIONS_FILE = path.join(DATA_DIR, 'notifications.json');
const SETTINGS_FILE = path.join(DATA_DIR, 'settings.json');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
function initDataFiles() {
    if (!fs.existsSync(DATA_DIR)) {
        fs.mkdirSync(DATA_DIR);
    }

    const defaultFiles = {
        [USERS_FILE]: [
            {
                id: '1',
                username: 'owner',
                password: 'owner2024',
                role: 'owner',
                displayName: '–í–ª–∞–¥–µ–ª–µ—Ü',
                avatar: 'üëë',
                email: 'owner@system.com',
                rating: 5,
                ratingCount: 0,
                isOnline: false,
                socketId: null,
                createdAt: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                settings: { theme: 'light', notifications: true, sound: true }
            },
            {
                id: '2',
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                displayName: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                avatar: '‚öôÔ∏è',
                email: 'admin@system.com',
                rating: 5,
                ratingCount: 0,
                isOnline: false,
                socketId: null,
                createdAt: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                settings: { theme: 'light', notifications: true, sound: true }
            },
            {
                id: '3',
                username: 'user',
                password: '123456',
                role: 'user',
                displayName: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                avatar: 'üë§',
                email: 'user@test.com',
                rating: 0,
                ratingCount: 0,
                isOnline: false,
                socketId: null,
                createdAt: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                settings: { theme: 'light', notifications: true, sound: true }
            },
            {
                id: '4',
                username: 'listener',
                password: '123456',
                role: 'listener',
                displayName: '–ê–Ω–Ω–∞ –°–ª—É—à–∞—Ç–µ–ª—å',
                avatar: 'üéß',
                email: 'listener@test.com',
                rating: 4.8,
                ratingCount: 15,
                isOnline: false,
                socketId: null,
                createdAt: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                settings: { theme: 'light', notifications: true, sound: true }
            }
        ],
        [CHATS_FILE]: [],
        [RATINGS_FILE]: [],
        [NOTIFICATIONS_FILE]: [],
        [SETTINGS_FILE]: {
            siteTitle: "–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
            theme: "light",
            maxChatDuration: 60,
            allowUserRegistration: true
        }
    };

    Object.entries(defaultFiles).forEach(([filePath, defaultData]) => {
        if (!fs.existsSync(filePath)) {
            fs.writeFileSync(filePath, JSON.stringify(defaultData, null, 2));
            console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: ${path.basename(filePath)}`);
        }
    });
}

// –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
function readJSON(filePath) {
    try {
        if (fs.existsSync(filePath)) {
            const data = fs.readFileSync(filePath, 'utf8');
            return JSON.parse(data);
        }
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è ${filePath}:`, error);
    }
    return null;
}

function writeJSON(filePath, data) {
    try {
        fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
        return true;
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ ${filePath}:`, error);
        return false;
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
let users = [];
let chats = [];
let ratings = [];
let notifications = [];
let settings = {};

function loadAllData() {
    users = readJSON(USERS_FILE) || [];
    chats = readJSON(CHATS_FILE) || [];
    ratings = readJSON(RATINGS_FILE) || [];
    notifications = readJSON(NOTIFICATIONS_FILE) || [];
    settings = readJSON(SETTINGS_FILE) || {};
    console.log('üìä –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', { 
        users: users.length, 
        chats: chats.length, 
        ratings: ratings.length,
        notifications: notifications.length 
    });
}

function saveAllData() {
    writeJSON(USERS_FILE, users);
    writeJSON(CHATS_FILE, chats);
    writeJSON(RATINGS_FILE, ratings);
    writeJSON(NOTIFICATIONS_FILE, notifications);
    writeJSON(SETTINGS_FILE, settings);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function generateId() {
    return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function getUserById(id) {
    return users.find(u => u.id === id);
}

function getUserBySocketId(socketId) {
    return users.find(u => u.socketId === socketId);
}

function getUserByUsername(username) {
    return users.find(u => u.username === username);
}

function updateUser(id, updates) {
    const userIndex = users.findIndex(u => u.id === id);
    if (userIndex !== -1) {
        users[userIndex] = { ...users[userIndex], ...updates };
        writeJSON(USERS_FILE, users);
        return users[userIndex];
    }
    return null;
}

function getUserChats(userId) {
    return chats.filter(chat => 
        chat.user1 === userId || chat.user2 === userId
    );
}

// Socket.IO –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
io.on('connection', (socket) => {
    console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:', socket.id);

    // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
    socket.on('login', (data) => {
        console.log('üö™ –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞:', data.username);
        
        const { username, password } = data;
        
        if (!username || !password) {
            socket.emit('login_error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        const user = getUserByUsername(username);
        
        // –í–ê–ñ–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if (!user || user.password !== password) {
            console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å:', { username, exists: !!user });
            socket.emit('login_error', '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user.isOnline = true;
        user.socketId = socket.id;
        user.lastSeen = new Date().toISOString();
        writeJSON(USERS_FILE, users);

        console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:', user.username);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        socket.emit('login_success', { 
            user: { ...user, password: undefined }, // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
            settings 
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        if (user.role === 'admin' || user.role === 'owner') {
            socket.emit('users_list', { users: users.filter(u => u.id !== user.id) });
            socket.emit('chats_list', { chats });
        } else {
            socket.emit('users_list', { 
                users: users.filter(u => 
                    (u.role === 'listener' || u.role === 'admin') && u.id !== user.id
                ) 
            });
            socket.emit('chats_list', { chats: getUserChats(user.id) });
        }

        socket.emit('ratings_list', { ratings });
        socket.emit('notifications_list', { notifications });

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        socket.broadcast.emit('user_connected', { user: { ...user, password: undefined } });
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    socket.on('register', (data) => {
        console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:', data.username);
        
        const { username, password, displayName, email } = data;
        
        if (!username || !password) {
            socket.emit('registration_error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        if (getUserByUsername(username)) {
            socket.emit('registration_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        const newUser = {
            id: generateId(),
            username,
            password,
            role: 'user',
            displayName: displayName || username,
            avatar: 'üë§',
            email: email || '',
            rating: 0,
            ratingCount: 0,
            isOnline: true,
            socketId: socket.id,
            createdAt: new Date().toISOString(),
            lastSeen: new Date().toISOString(),
            settings: { theme: 'light', notifications: true, sound: true }
        };

        users.push(newUser);
        writeJSON(USERS_FILE, users);

        console.log('‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', username);

        socket.emit('registration_success', { 
            user: { ...newUser, password: undefined },
            settings 
        });

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        socket.emit('users_list', { 
            users: users.filter(u => 
                (u.role === 'listener' || u.role === 'admin') && u.id !== newUser.id
            ) 
        });
        socket.emit('chats_list', { chats: getUserChats(newUser.id) });
        socket.emit('ratings_list', { ratings });
        socket.emit('notifications_list', { notifications });

        socket.broadcast.emit('user_connected', { user: { ...newUser, password: undefined } });
    });

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    socket.on('restore_session', (data) => {
        console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏:', data.userId);
        
        const user = getUserById(data.userId);
        if (user) {
            user.isOnline = true;
            user.socketId = socket.id;
            user.lastSeen = new Date().toISOString();
            writeJSON(USERS_FILE, users);

            socket.emit('session_restored', { 
                user: { ...user, password: undefined },
                settings 
            });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (user.role === 'admin' || user.role === 'owner') {
                socket.emit('users_list', { users: users.filter(u => u.id !== user.id) });
                socket.emit('chats_list', { chats });
            } else {
                socket.emit('users_list', { 
                    users: users.filter(u => 
                        (u.role === 'listener' || u.role === 'admin') && u.id !== user.id
                    ) 
                });
                socket.emit('chats_list', { chats: getUserChats(user.id) });
            }

            socket.emit('ratings_list', { ratings });
            socket.emit('notifications_list', { notifications });

            socket.broadcast.emit('user_connected', { user: { ...user, password: undefined } });
        } else {
            socket.emit('session_restored', { error: '–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
        }
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    socket.on('get_users', () => {
        const user = getUserBySocketId(socket.id);
        if (user) {
            if (user.role === 'admin' || user.role === 'owner') {
                socket.emit('users_list', { users: users.filter(u => u.id !== user.id) });
            } else {
                socket.emit('users_list', { 
                    users: users.filter(u => 
                        (u.role === 'listener' || u.role === 'admin') && u.id !== user.id
                    ) 
                });
            }
        }
    });

    socket.on('get_chats', () => {
        const user = getUserBySocketId(socket.id);
        if (user) {
            if (user.role === 'admin' || user.role === 'owner') {
                socket.emit('chats_list', { chats });
            } else {
                socket.emit('chats_list', { chats: getUserChats(user.id) });
            }
        }
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
    socket.on('create_chat', (data) => {
        console.log('üí¨ –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞:', data);
        
        const user = getUserBySocketId(socket.id);
        const listener = getUserById(data.listenerId);
        
        if (!user || !listener) {
            socket.emit('chat_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
        const existingChat = chats.find(chat => 
            chat.isActive && 
            ((chat.user1 === user.id && chat.user2 === listener.id) || 
             (chat.user1 === listener.id && chat.user2 === user.id))
        );

        if (existingChat) {
            socket.emit('chat_exists', { chat: existingChat });
            return;
        }

        const newChat = {
            id: generateId(),
            user1: user.id,
            user2: listener.id,
            messages: [],
            startTime: new Date().toISOString(),
            isActive: true,
            lastActivity: new Date().toISOString()
        };

        chats.push(newChat);
        writeJSON(CHATS_FILE, chats);

        console.log('‚úÖ –°–æ–∑–¥–∞–Ω —á–∞—Ç:', user.username, '->', listener.username);

        // –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        [user, listener].forEach(participant => {
            if (participant.socketId) {
                io.to(participant.socketId).emit('chat_created', { 
                    chat: newChat,
                    partner: participant.id === user.id ? listener : user
                });
                io.to(participant.socketId).emit('chats_list', { 
                    chats: getUserChats(participant.id) 
                });
            }
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    socket.on('send_message', (data) => {
        console.log('üì® –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç:', data.chatId);
        
        const user = getUserBySocketId(socket.id);
        const chat = chats.find(c => c.id === data.chatId);
        
        if (!user || !chat) {
            socket.emit('message_error', '–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        if (!chat.messages) chat.messages = [];

        const newMessage = {
            id: generateId(),
            text: data.message.text,
            senderId: user.id,
            timestamp: new Date().toISOString(),
            read: false
        };

        chat.messages.push(newMessage);
        chat.lastActivity = new Date().toISOString();
        writeJSON(CHATS_FILE, chats);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞
        const participants = [chat.user1, chat.user2];
        participants.forEach(participantId => {
            const participant = getUserById(participantId);
            if (participant && participant.socketId) {
                io.to(participant.socketId).emit('new_message', {
                    chatId: chat.id,
                    message: newMessage
                });
                io.to(participant.socketId).emit('chats_list', {
                    chats: getUserChats(participant.id)
                });
            }
        });
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞
    socket.on('register_staff', (data) => {
        console.log('‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞:', data.username);
        
        const admin = getUserBySocketId(socket.id);
        
        if (!admin || (admin.role !== 'admin' && admin.role !== 'owner')) {
            socket.emit('staff_add_error', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
            return;
        }

        const { username, password, displayName, role, email } = data;

        if (getUserByUsername(username)) {
            socket.emit('staff_add_error', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return;
        }

        const newStaff = {
            id: generateId(),
            username,
            password,
            role: role || 'listener',
            displayName: displayName || username,
            avatar: role === 'admin' ? '‚öôÔ∏è' : 'üéß',
            email: email || '',
            rating: 0,
            ratingCount: 0,
            isOnline: false,
            socketId: null,
            createdAt: new Date().toISOString(),
            lastSeen: new Date().toISOString(),
            settings: { theme: 'light', notifications: true, sound: true }
        };

        users.push(newStaff);
        writeJSON(USERS_FILE, users);

        console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–ª:', username);

        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        users.filter(u => u.role === 'admin' || u.role === 'owner').forEach(adminUser => {
            if (adminUser.socketId) {
                io.to(adminUser.socketId).emit('staff_added', { user: newStaff });
                io.to(adminUser.socketId).emit('users_list', { 
                    users: users.filter(u => u.id !== adminUser.id) 
                });
            }
        });

        socket.emit('staff_added', { user: newStaff });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    socket.on('update_profile', (data) => {
        const user = getUserBySocketId(socket.id);
        if (!user) return;

        const updates = {};
        if (data.displayName) updates.displayName = data.displayName;
        if (data.email) updates.email = data.email;
        if (data.avatar) updates.avatar = data.avatar;
        if (data.settings) updates.settings = { ...user.settings, ...data.settings };
        if (data.password) updates.password = data.password;

        const updatedUser = updateUser(user.id, updates);
        
        if (updatedUser) {
            socket.emit('profile_updated', { user: { ...updatedUser, password: undefined } });
            socket.broadcast.emit('user_updated', { user: { ...updatedUser, password: undefined } });
        }
    });

    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
    socket.on('disconnect', () => {
        console.log('üîå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ:', socket.id);
        
        const user = getUserBySocketId(socket.id);
        if (user) {
            user.isOnline = false;
            user.socketId = null;
            user.lastSeen = new Date().toISOString();
            writeJSON(USERS_FILE, users);

            socket.broadcast.emit('user_disconnected', { userId: user.id });
        }
    });
});

// API routes
app.get('/api/users', (req, res) => {
    res.json(users.map(u => ({ ...u, password: undefined })));
});

app.get('/api/stats', (req, res) => {
    const stats = {
        totalUsers: users.filter(u => u.role === 'user').length,
        totalListeners: users.filter(u => u.role === 'listener').length,
        activeChats: chats.filter(c => c.isActive).length,
        onlineUsers: users.filter(u => u.isOnline).length
    };
    res.json(stats);
});

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
initDataFiles();
loadAllData();

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, ${chats.length} —á–∞—Ç–æ–≤`);
    console.log(`üîê –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:`);
    console.log(`   üëë –í–ª–∞–¥–µ–ª–µ—Ü: owner / owner2024`);
    console.log(`   ‚öôÔ∏è –ê–¥–º–∏–Ω: admin / admin123`);
    console.log(`   üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: user / 123456`);
    console.log(`   üéß –°–ª—É—à–∞—Ç–µ–ª—å: listener / 123456`);
    console.log(`üåê http://localhost:${PORT}`);
});
