// üÜï –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–ê–õ–¨–ù–´–• –ß–ê–¢–û–í

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
async function createChatWithAdmin(adminUsername) {
    const admin = getAdminByUsername(adminUsername);
    if (!admin) {
        showNotification('‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        return null;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç –≤ localStorage
    const chats = JSON.parse(localStorage.getItem('chats')) || [];
    const existingChat = chats.find(chat => 
        chat.userId === currentUser.username && 
        chat.adminUsername === adminUsername && 
        chat.status === 'active'
    );

    if (existingChat) {
        return existingChat.id;
    }

    const newChat = {
        id: generateId(),
        userId: currentUser.username,
        adminUsername: adminUsername,
        adminSpecialty: admin.specialty,
        status: 'active',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        messages: [],
        hasUnread: false
    };

    chats.push(newChat);
    localStorage.setItem('chats', JSON.stringify(chats));
    
    return newChat.id;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω—ã–π —á–∞—Ç
async function sendRealMessage(chatId, messageText) {
    const chats = JSON.parse(localStorage.getItem('chats')) || [];
    const chat = chats.find(c => c.id === chatId);
    
    if (!chat) {
        showNotification('‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        return;
    }

    const message = {
        id: generateId(),
        chatId: chatId,
        from: currentUser.username,
        text: messageText,
        timestamp: new Date().toISOString(),
        isRead: false,
        type: 'text'
    };

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    chat.messages.push(message);
    chat.updatedAt = new Date().toISOString();
    chat.hasUnread = true;
    
    localStorage.setItem('chats', JSON.stringify(chats));
    
    // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ "—Ä–µ–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É"
    simulateMessageDelivery(chatId, message);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    addMessageToChat(chatId, message);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    updateChatsList();
}

// –ò–º–∏—Ç–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–∞
function simulateMessageDelivery(chatId, userMessage) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ "–∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π"
    const allMessages = JSON.parse(localStorage.getItem('allMessages')) || [];
    allMessages.push({
        ...userMessage,
        delivered: true
    });
    localStorage.setItem('allMessages', JSON.stringify(allMessages));

    // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ 1-3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        const adminResponses = [
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –≤–æ–ø—Ä–æ—Å.",
            "–ü–æ–Ω—è–ª –≤–∞—Å. –°–µ–π—á–∞—Å —Ä–∞–∑–±–µ—Ä—É—Å—å —Å –≤–∞—à–∏–º –≤–æ–ø—Ä–æ—Å–æ–º.",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏.",
            "–£–∂–µ –∑–∞–Ω–∏–º–∞—é—Å—å –≤–∞—à–µ–π –ø—Ä–æ–±–ª–µ–º–æ–π. –°–∫–æ—Ä–æ –≤–µ—Ä–Ω—É—Å—å —Å –æ—Ç–≤–µ—Ç–æ–º."
        ];
        
        const response = adminResponses[Math.floor(Math.random() * adminResponses.length)];
        
        const adminMessage = {
            id: generateId(),
            chatId: chatId,
            from: getChatAdmin(chatId),
            text: response,
            timestamp: new Date().toISOString(),
            isRead: false,
            type: 'text'
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞
        const chats = JSON.parse(localStorage.getItem('chats')) || [];
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            chat.messages.push(adminMessage);
            chat.updatedAt = new Date().toISOString();
            localStorage.setItem('chats', JSON.stringify(chats));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            addMessageToChat(chatId, adminMessage);
            showNotification(`üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${adminMessage.from}`, 'info');
        }
        
    }, 1000 + Math.random() * 2000);
}

// üÜï –°–ò–°–¢–ï–ú–ê –û–¢–ó–´–í–û–í
function createReview(chatId, rating, comment) {
    const reviews = JSON.parse(localStorage.getItem('reviews')) || [];
    const chat = getChatById(chatId);
    
    if (!chat) {
        showNotification('‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        return;
    }

    const review = {
        id: generateId(),
        chatId: chatId,
        adminUsername: chat.adminUsername,
        userUsername: currentUser.username,
        rating: rating,
        comment: comment,
        createdAt: new Date().toISOString()
    };

    reviews.push(review);
    localStorage.setItem('reviews', JSON.stringify(reviews));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    updateAdminRating(chat.adminUsername);
    
    showNotification('‚≠ê –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!', 'success');
}

// üÜï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function createTechnicalNotification(title, message) {
    const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
    
    const notification = {
        id: generateId(),
        type: 'technical',
        title: title,
        message: message,
        isRead: false,
        createdAt: new Date().toISOString()
    };

    notifications.push(notification);
    localStorage.setItem('notifications', JSON.stringify(notifications));
    
    showNotification(`üîî ${title}`, 'info');
}

// üÜï –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–û–í
function showChatsList() {
    const chats = getUsersChats();
    
    let html = '<div class="chats-header"><h3>üí¨ –ú–æ–∏ —á–∞—Ç—ã</h3></div>';
    
    if (chats.length === 0) {
        html += '<div class="empty-state">üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
    } else {
        chats.forEach(chat => {
            const lastMessage = chat.messages[chat.messages.length - 1];
            const unreadCount = chat.messages.filter(m => !m.isRead && m.from !== currentUser.username).length;
            
            html += `
                <div class="chat-item" onclick="openChat('${chat.id}')">
                    <div class="chat-avatar">${getInitials(chat.adminUsername)}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.adminUsername}</div>
                        <div class="chat-specialty">${chat.adminSpecialty}</div>
                        <div class="chat-last-message">${lastMessage ? lastMessage.text : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${formatTime(chat.updatedAt)}</div>
                        ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —á–∞—Ç
    html += `
        <div class="chat-item technical-chat" onclick="openTechnicalChat()">
            <div class="chat-avatar">üîî</div>
            <div class="chat-info">
                <div class="chat-name">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <div class="chat-specialty">–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                <div class="chat-last-message">–í–∞–∂–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            </div>
        </div>
    `;
    
    document.getElementById('chatsList').innerHTML = html;
}

// üÜï –û–¢–ö–†–´–¢–ò–ï –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ß–ê–¢–ê
function openChat(chatId) {
    const chat = getChatById(chatId);
    if (!chat) return;
    
    // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    markChatAsRead(chatId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞
    showChatInterface(chat);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∑—ã–≤–∞
    const chatHeader = document.querySelector('.chat-header');
    chatHeader.innerHTML += `
        <button class="btn-review" onclick="showReviewModal('${chatId}')">
            ‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
        </button>
    `;
}

// üÜï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –û–¢–ó–´–í–û–í
function showReviewModal(chatId) {
    const modalHtml = `
        <div class="modal-overlay active" onclick="closeModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="rating-stars">
                        ${[1,2,3,4,5].map(star => `
                            <span class="star" onclick="setRating(${star})">${star <= currentRating ? '‚≠ê' : '‚òÜ'}</span>
                        `).join('')}
                    </div>
                    <textarea class="review-comment" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitReview('${chatId}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    currentRating = 0;
}

let currentRating = 0;
function setRating(rating) {
    currentRating = rating;
    const stars = document.querySelectorAll('.star');
    stars.forEach((star, index) => {
        star.textContent = index < rating ? '‚≠ê' : '‚òÜ';
    });
}

function submitReview(chatId) {
    const comment = document.querySelector('.review-comment').value;
    
    if (currentRating === 0) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É', 'error');
        return;
    }
    
    createReview(chatId, currentRating, comment);
    closeModal();
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) modal.remove();
}

// üÜï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ß–ê–¢
function openTechnicalChat() {
    const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
    
    let html = `
        <div class="chat-header">
            <button class="back-btn" onclick="showChatsList()">‚Üê</button>
            <div>
                <h3>üîî –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                <p>–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>
            </div>
        </div>
        <div class="chat-messages technical-messages">
    `;
    
    if (notifications.length === 0) {
        html += '<div class="empty-state">üì≠ –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
    } else {
        notifications.forEach(notification => {
            html += `
                <div class="technical-message ${notification.type}">
                    <div class="tech-message-header">
                        <strong>${notification.title}</strong>
                        <span class="tech-time">${formatTime(notification.createdAt)}</span>
                    </div>
                    <div class="tech-message-text">${notification.message}</div>
                </div>
            `;
        });
    }
    
    html += '</div>';
    
    document.getElementById('chatsContainer').innerHTML = html;
    
    // –ü–æ–º–µ—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    markNotificationsAsRead();
}

// üõ†Ô∏è –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function getChatById(chatId) {
    const chats = JSON.parse(localStorage.getItem('chats')) || [];
    return chats.find(chat => chat.id === chatId);
}

function getUsersChats() {
    const chats = JSON.parse(localStorage.getItem('chats')) || [];
    return chats.filter(chat => chat.userId === currentUser.username)
               .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
}

function getChatAdmin(chatId) {
    const chat = getChatById(chatId);
    return chat ? chat.adminUsername : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (diff < 86400000) return date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    return date.toLocaleDateString('ru-RU');
}

function getInitials(name) {
    return name.split(' ').map(word => word[0]).join('').toUpperCase();
}
