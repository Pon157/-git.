<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–æ–∫–æ–π–Ω—ã–π —Ä–∞—Å—Å–≤–µ—Ç</title>
    <style>
        /* –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú–ò - —è –∏—Ö –Ω–µ –º–µ–Ω—è–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ */
        /* ... –≤—Å–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body class="theme-sunrise">
    <!-- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h2 class="auth-title">–°–ø–æ–∫–æ–π–Ω—ã–π —Ä–∞—Å—Å–≤–µ—Ç</h2>
            <div class="tabs" style="margin-bottom: 20px;">
                <div class="tab active" onclick="showAuthTab('login')">–í—Ö–æ–¥</div>
                <div class="tab" onclick="showAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–∏–Ω</label>
                    <input type="text" class="form-input" id="authUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="authPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">
                    –í–æ–π—Ç–∏
                </button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–∏–Ω</label>
                    <input type="text" class="form-input" id="regUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" pattern="[A-Za-z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="regPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" minlength="6">
                </div>
                <button class="btn btn-primary" onclick="register()" style="width: 100%;">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>

            <!-- –ù–ê–°–¢–†–û–ô–ö–ò GITHUB -->
            <div style="margin-top: 20px; padding: 15px; background: var(--border-color); border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub</h4>
                <div class="form-group">
                    <label class="form-label">GitHub Token</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à GitHub Token">
                    <small style="color: #7f8c8d; font-size: 12px;">
                        –ù—É–∂–µ–Ω –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</label>
                    <input type="text" class="form-input" id="repoName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: my-support-data" value="support-system-data">
                </div>
                <button class="btn btn-secondary" onclick="saveGitHubConfig()" style="width: 100%;">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –û–°–¢–ê–õ–¨–ù–ê–Ø –†–ê–ó–ú–ï–¢–ö–ê –û–°–¢–ê–ï–¢–°–Ø –ü–†–ï–ñ–ù–ï–ô -->
    <!-- ... –≤–µ—Å—å –≤–∞—à HTML –∫–æ–¥ ... -->

    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const GITHUB_OWNER = 'your-github-username'; // –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à GitHub username
        const DEFAULT_REPO = 'support-system-data';
        const DATA_FILE = 'database.json';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let currentChat = null;
        let currentUserChat = null;
        let isFullscreen = false;
        let githubToken = '';
        let repoName = DEFAULT_REPO;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
        async function init() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
            await loadGitHubConfig();
            await initDatabase();
            checkActiveSession();
            setupEnterHandlers();
            
            window.addEventListener('orientationchange', function() {
                setTimeout(adjustMobileLayout, 300);
            });
            
            window.addEventListener('resize', adjustMobileLayout);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ GitHub
        async function loadGitHubConfig() {
            const savedToken = localStorage.getItem('githubToken');
            const savedRepo = localStorage.getItem('repoName');
            
            if (savedToken) {
                githubToken = savedToken;
                document.getElementById('githubToken').value = savedToken;
            }
            
            if (savedRepo) {
                repoName = savedRepo;
                document.getElementById('repoName').value = savedRepo;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ GitHub
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            
            if (!token) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ GitHub Token!', 'error');
                return;
            }
            
            if (!repo) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!', 'error');
                return;
            }
            
            githubToken = token;
            repoName = repo;
            
            localStorage.setItem('githubToken', token);
            localStorage.setItem('repoName', repo);
            
            showNotification('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async function initDatabase() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å GitHub
                const remoteData = await loadFromGitHub();
                
                if (remoteData) {
                    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å GitHub');
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å GitHub
                    Object.keys(remoteData).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(remoteData[key]));
                    });
                } else {
                    console.log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                    const defaults = {
                        users: [
                            {
                                username: 'admin',
                                password: 'admin123',
                                role: '–í–ª–∞–¥–µ–ª–µ—Ü',
                                isOnline: false,
                                registeredAt: new Date().toISOString(),
                                lastLogin: null,
                                rating: 5.0,
                                ratingCount: 1,
                                email: 'admin@system.com',
                                displayName: '–í–ª–∞–¥–µ–ª–µ—Ü',
                                avatar: ''
                            }
                        ],
                        chats: [],
                        systemLogs: [],
                        techNotifications: [],
                        settings: {
                            currentTheme: 'sunrise'
                        }
                    };

                    Object.keys(defaults).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(defaults[key]));
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –Ω–∞ GitHub
                    await saveToGitHub();
                }
                
                const settings = JSON.parse(localStorage.getItem('settings'));
                changeTheme(settings.currentTheme || 'sunrise');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö', 'warning');
            }
        }

        // GitHub API —Ñ—É–Ω–∫—Ü–∏–∏
        async function loadFromGitHub() {
            if (!githubToken) {
                console.log('GitHub Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
                return null;
            }
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                    {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.status === 404) {
                    console.log('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ GitHub');
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                return content;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å GitHub:', error);
                return null;
            }
        }

        async function saveToGitHub() {
            if (!githubToken) {
                console.log('GitHub Token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ');
                return false;
            }
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const database = {
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    chats: JSON.parse(localStorage.getItem('chats') || '[]'),
                    systemLogs: JSON.parse(localStorage.getItem('systemLogs') || '[]'),
                    techNotifications: JSON.parse(localStorage.getItem('techNotifications') || '[]'),
                    settings: JSON.parse(localStorage.getItem('settings') || '{}')
                };
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π SHA —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                let sha = null;
                try {
                    const currentFile = await fetch(
                        `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                        {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (currentFile.ok) {
                        const fileData = await currentFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                }
                
                const content = btoa(JSON.stringify(database, null, 2));
                
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Auto-sync: ${new Date().toISOString()}`,
                            content: content,
                            sha: sha
                        })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                console.log('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ GitHub');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ GitHub:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub', 'error');
                return false;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
        async function saveData() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            const dataToSave = arguments[0];
            const key = arguments[1];
            
            if (key) {
                localStorage.setItem(key, JSON.stringify(dataToSave));
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å GitHub
            await saveToGitHub();
        }

        async function login() {
            console.log('–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞...');
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();

            if (!username || !password) {
                showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                console.log('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è:', username);
                currentUser = user;
                
                user.isOnline = true;
                user.lastLogin = new Date().toISOString();
                await saveData(users, 'users');
                
                localStorage.setItem('activeUser', JSON.stringify({
                    username: username,
                    password: password,
                    loginTime: Date.now()
                }));

                showNotification('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');

                setTimeout(() => {
                    if (user.role === 'user') {
                        showUserInterface();
                    } else {
                        showAdminPanel();
                    }
                }, 500);

            } else {
                console.log('–ù–µ—É–¥–∞—á–Ω—ã–π –≤—Ö–æ–¥ –¥–ª—è:', username);
                showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!', 'error');
            }
        }

        async function register() {
            console.log('–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...');
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();

            if (!username || !password || !passwordConfirm) {
                showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }

            const usernameRegex = /^[A-Za-z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                showNotification('‚ùå –õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ!', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showNotification('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users.find(u => u.username === username)) {
                showNotification('‚ùå –≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç!', 'error');
                return;
            }

            const newUser = {
                username: username,
                password: password,
                role: 'user',
                isOnline: false,
                registeredAt: new Date().toISOString(),
                lastLogin: null,
                rating: 0,
                ratingCount: 0,
                email: '',
                displayName: username,
                avatar: ''
            };

            users.push(newUser);
            await saveData(users, 'users');

            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';
            
            showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!`, 'success');
            
            showAuthTab('login');
        }

        async function createAdmin() {
            const login = document.getElementById('newAdminLogin').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();
            const role = document.getElementById('newAdminRole').value;

            if (!login || !password) {
                showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users.find(u => u.username === login)) {
                showNotification('‚ùå –≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç!', 'error');
                return;
            }

            const newAdmin = {
                username: login,
                password: password,
                role: role,
                isOnline: false,
                registeredAt: new Date().toISOString(),
                lastLogin: null,
                rating: 0,
                ratingCount: 0,
                email: '',
                displayName: login,
                avatar: ''
            };

            users.push(newAdmin);
            await saveData(users, 'users');

            document.getElementById('newAdminLogin').value = '';
            document.getElementById('newAdminPassword').value = '';
            
            showNotification(`‚úÖ ${role} "${login}" —Å–æ–∑–¥–∞–Ω!`, 'success');
            
            updateStats();
            loadUsersTable();
        }

        async function changeUserRole(username, newRole) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username} –Ω–∞ "${newRole}"?`)) {
                loadUsersTable();
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex !== -1) {
                users[userIndex].role = newRole;
                await saveData(users, 'users');
                
                showNotification(`‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "${newRole}"!`, 'success');
                
                loadUsersTable();
                updateStats();
            }
        }

        async function deleteUser(username) {
            if (username === currentUser.username) {
                showNotification('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!', 'error');
                return;
            }

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const updatedUsers = users.filter(u => u.username !== username);
            await saveData(updatedUsers, 'users');
            
            showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} —É–¥–∞–ª–µ–Ω!`, 'success');
            
            updateStats();
            loadUsersTable();
        }

        async function sendTechNotification() {
            if (!['–í–ª–∞–¥–µ–ª–µ—Ü', '–°–æ–≤–ª–∞–¥–µ–ª–µ—Ü'].includes(currentUser.role)) {
                showNotification('‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏ —Å–æ–≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!', 'error');
                return;
            }

            const message = document.getElementById('techNotificationInput').value.trim();
            if (!message) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!', 'error');
                return;
            }

            const notifications = JSON.parse(localStorage.getItem('techNotifications')) || [];
            const newNotification = {
                id: Date.now(),
                message: message,
                timestamp: new Date().toISOString(),
                sender: currentUser.username
            };

            notifications.unshift(newNotification);
            if (notifications.length > 50) notifications.length = 50;
            
            await saveData(notifications, 'techNotifications');
            
            document.getElementById('techNotificationInput').value = '';
            showNotification('‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            loadTechNotifications();
        }

        async function updateProfileFromSettings() {
            const newUsername = document.getElementById('settingsUsername').value.trim();
            const newEmail = document.getElementById('settingsEmail').value.trim();

            if (!newUsername) {
                showNotification('‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex !== -1) {
                if (newUsername !== currentUser.username && users.find(u => u.username === newUsername)) {
                    showNotification('‚ùå –≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!', 'error');
                    return;
                }
                
                users[userIndex].displayName = newUsername;
                users[userIndex].email = newEmail;
                
                if (newUsername !== currentUser.username) {
                    users[userIndex].username = newUsername;
                    
                    const activeUser = JSON.parse(localStorage.getItem('activeUser'));
                    activeUser.username = newUsername;
                    localStorage.setItem('activeUser', JSON.stringify(activeUser));
                    
                    currentUser.username = newUsername;
                }
                
                await saveData(users, 'users');
                currentUser = users[userIndex];
                
                showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                
                updateSettingsProfile();
                document.getElementById('currentUserInfo').textContent = 
                    `${currentUser.displayName} | ${currentUser.role}`;
            }
        }

        // –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–°–¢–ê–Æ–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú–ò
        // ... –≤–µ—Å—å –≤–∞—à JavaScript –∫–æ–¥ ...

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function addSyncButton() {
            const headerActions = document.querySelector('.header-actions');
            if (headerActions && !document.getElementById('syncBtn')) {
                const syncBtn = document.createElement('button');
                syncBtn.id = 'syncBtn';
                syncBtn.className = 'btn btn-success';
                syncBtn.innerHTML = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
                syncBtn.onclick = forceSync;
                syncBtn.style.marginLeft = '10px';
                headerActions.appendChild(syncBtn);
            }
        }

        async function forceSync() {
            showNotification('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info');
            try {
                await initDatabase();
                showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                if (currentUser) {
                    if (currentUser.role === 'user') {
                        loadUserChatsList();
                    } else {
                        updateStats();
                        loadUsersTable();
                        loadChatsList();
                    }
                }
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = init;
    </script>
</body>
</html>
