<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Спокойный рассвет</title>
    <style>
        /* СТИЛИ ОСТАЮТСЯ ПРЕЖНИМИ - я их не менял для краткости */
        /* ... все ваши стили ... */
    </style>
</head>
<body class="theme-sunrise">
    <!-- ЭКРАН АВТОРИЗАЦИИ -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h2 class="auth-title">Спокойный рассвет</h2>
            <div class="tabs" style="margin-bottom: 20px;">
                <div class="tab active" onclick="showAuthTab('login')">Вход</div>
                <div class="tab" onclick="showAuthTab('register')">Регистрация</div>
            </div>
            
            <!-- Форма входа -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Логин</label>
                    <input type="text" class="form-input" id="authUsername" placeholder="Введите логин">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="authPassword" placeholder="Введите пароль">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">
                    Войти
                </button>
            </div>
            
            <!-- Форма регистрации -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Логин</label>
                    <input type="text" class="form-input" id="regUsername" placeholder="Введите логин" pattern="[A-Za-z0-9_]+" title="Только латинские буквы, цифры и подчеркивание">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="Введите пароль (мин. 6 символов)" minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Подтвердите пароль</label>
                    <input type="password" class="form-input" id="regPasswordConfirm" placeholder="Повторите пароль" minlength="6">
                </div>
                <button class="btn btn-primary" onclick="register()" style="width: 100%;">
                    Зарегистрироваться
                </button>
            </div>

            <!-- НАСТРОЙКИ GITHUB -->
            <div style="margin-top: 20px; padding: 15px; background: var(--border-color); border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">Настройки GitHub</h4>
                <div class="form-group">
                    <label class="form-label">GitHub Token</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="Введите ваш GitHub Token">
                    <small style="color: #7f8c8d; font-size: 12px;">
                        Нужен для синхронизации данных между устройствами
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Имя репозитория</label>
                    <input type="text" class="form-input" id="repoName" placeholder="например: my-support-data" value="support-system-data">
                </div>
                <button class="btn btn-secondary" onclick="saveGitHubConfig()" style="width: 100%;">
                    Сохранить настройки
                </button>
            </div>
        </div>
    </div>

    <!-- ОСТАЛЬНАЯ РАЗМЕТКА ОСТАЕТСЯ ПРЕЖНЕЙ -->
    <!-- ... весь ваш HTML код ... -->

    <script>
        // КОНФИГУРАЦИЯ
        const GITHUB_OWNER = 'your-github-username'; // ЗАМЕНИТЕ на ваш GitHub username
        const DEFAULT_REPO = 'support-system-data';
        const DATA_FILE = 'database.json';

        // Глобальные переменные
        let currentUser = null;
        let currentChat = null;
        let currentUserChat = null;
        let isFullscreen = false;
        let githubToken = '';
        let repoName = DEFAULT_REPO;

        // Инициализация системы
        async function init() {
            console.log('Инициализация системы...');
            await loadGitHubConfig();
            await initDatabase();
            checkActiveSession();
            setupEnterHandlers();
            
            window.addEventListener('orientationchange', function() {
                setTimeout(adjustMobileLayout, 300);
            });
            
            window.addEventListener('resize', adjustMobileLayout);
        }

        // Загрузка конфигурации GitHub
        async function loadGitHubConfig() {
            const savedToken = localStorage.getItem('githubToken');
            const savedRepo = localStorage.getItem('repoName');
            
            if (savedToken) {
                githubToken = savedToken;
                document.getElementById('githubToken').value = savedToken;
            }
            
            if (savedRepo) {
                repoName = savedRepo;
                document.getElementById('repoName').value = savedRepo;
            }
        }

        // Сохранение конфигурации GitHub
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            
            if (!token) {
                showNotification('❌ Введите GitHub Token!', 'error');
                return;
            }
            
            if (!repo) {
                showNotification('❌ Введите имя репозитория!', 'error');
                return;
            }
            
            githubToken = token;
            repoName = repo;
            
            localStorage.setItem('githubToken', token);
            localStorage.setItem('repoName', repo);
            
            showNotification('✅ Настройки GitHub сохранены!', 'success');
        }

        // Инициализация базы данных
        async function initDatabase() {
            console.log('Инициализация базы данных...');
            
            try {
                // Пытаемся загрузить данные с GitHub
                const remoteData = await loadFromGitHub();
                
                if (remoteData) {
                    console.log('Данные загружены с GitHub');
                    // Используем данные с GitHub
                    Object.keys(remoteData).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(remoteData[key]));
                    });
                } else {
                    console.log('Создание новой базы данных...');
                    // Создаем новую базу данных
                    const defaults = {
                        users: [
                            {
                                username: 'admin',
                                password: 'admin123',
                                role: 'Владелец',
                                isOnline: false,
                                registeredAt: new Date().toISOString(),
                                lastLogin: null,
                                rating: 5.0,
                                ratingCount: 1,
                                email: 'admin@system.com',
                                displayName: 'Владелец',
                                avatar: ''
                            }
                        ],
                        chats: [],
                        systemLogs: [],
                        techNotifications: [],
                        settings: {
                            currentTheme: 'sunrise'
                        }
                    };

                    Object.keys(defaults).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(defaults[key]));
                    });
                    
                    // Сохраняем новую базу на GitHub
                    await saveToGitHub();
                }
                
                const settings = JSON.parse(localStorage.getItem('settings'));
                changeTheme(settings.currentTheme || 'sunrise');
                
            } catch (error) {
                console.error('Ошибка инициализации базы данных:', error);
                showNotification('⚠️ Используется локальная база данных', 'warning');
            }
        }

        // GitHub API функции
        async function loadFromGitHub() {
            if (!githubToken) {
                console.log('GitHub Token не настроен');
                return null;
            }
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                    {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.status === 404) {
                    console.log('Файл данных не найден на GitHub');
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = JSON.parse(atob(data.content));
                return content;
                
            } catch (error) {
                console.error('Ошибка загрузки с GitHub:', error);
                return null;
            }
        }

        async function saveToGitHub() {
            if (!githubToken) {
                console.log('GitHub Token не настроен, пропускаем сохранение');
                return false;
            }
            
            try {
                // Собираем все данные из localStorage
                const database = {
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    chats: JSON.parse(localStorage.getItem('chats') || '[]'),
                    systemLogs: JSON.parse(localStorage.getItem('systemLogs') || '[]'),
                    techNotifications: JSON.parse(localStorage.getItem('techNotifications') || '[]'),
                    settings: JSON.parse(localStorage.getItem('settings') || '{}')
                };
                
                // Получаем текущий SHA файла (если существует)
                let sha = null;
                try {
                    const currentFile = await fetch(
                        `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                        {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (currentFile.ok) {
                        const fileData = await currentFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // Файл не существует, это нормально
                }
                
                const content = btoa(JSON.stringify(database, null, 2));
                
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${repoName}/contents/${DATA_FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Auto-sync: ${new Date().toISOString()}`,
                            content: content,
                            sha: sha
                        })
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                console.log('Данные сохранены на GitHub');
                return true;
                
            } catch (error) {
                console.error('Ошибка сохранения на GitHub:', error);
                showNotification('❌ Ошибка синхронизации с GitHub', 'error');
                return false;
            }
        }

        // Обновленные функции для работы с данными
        async function saveData() {
            // Сохраняем в localStorage
            const dataToSave = arguments[0];
            const key = arguments[1];
            
            if (key) {
                localStorage.setItem(key, JSON.stringify(dataToSave));
            }
            
            // Синхронизируем с GitHub
            await saveToGitHub();
        }

        async function login() {
            console.log('Попытка входа...');
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();

            if (!username || !password) {
                showNotification('❌ Заполните все поля!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                console.log('Успешный вход для:', username);
                currentUser = user;
                
                user.isOnline = true;
                user.lastLogin = new Date().toISOString();
                await saveData(users, 'users');
                
                localStorage.setItem('activeUser', JSON.stringify({
                    username: username,
                    password: password,
                    loginTime: Date.now()
                }));

                showNotification('✅ Вход выполнен успешно!', 'success');

                setTimeout(() => {
                    if (user.role === 'user') {
                        showUserInterface();
                    } else {
                        showAdminPanel();
                    }
                }, 500);

            } else {
                console.log('Неудачный вход для:', username);
                showNotification('❌ Неверный логин или пароль!', 'error');
            }
        }

        async function register() {
            console.log('Попытка регистрации...');
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();

            if (!username || !password || !passwordConfirm) {
                showNotification('❌ Заполните все поля!', 'error');
                return;
            }

            const usernameRegex = /^[A-Za-z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                showNotification('❌ Логин может содержать только латинские буквы, цифры и подчеркивание!', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showNotification('❌ Пароли не совпадают!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('❌ Пароль должен быть не менее 6 символов!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users.find(u => u.username === username)) {
                showNotification('❌ Этот логин уже занят!', 'error');
                return;
            }

            const newUser = {
                username: username,
                password: password,
                role: 'user',
                isOnline: false,
                registeredAt: new Date().toISOString(),
                lastLogin: null,
                rating: 0,
                ratingCount: 0,
                email: '',
                displayName: username,
                avatar: ''
            };

            users.push(newUser);
            await saveData(users, 'users');

            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';
            
            showNotification(`✅ Пользователь "${username}" зарегистрирован!`, 'success');
            
            showAuthTab('login');
        }

        async function createAdmin() {
            const login = document.getElementById('newAdminLogin').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();
            const role = document.getElementById('newAdminRole').value;

            if (!login || !password) {
                showNotification('❌ Заполните все поля!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('❌ Пароль должен быть не менее 6 символов!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users.find(u => u.username === login)) {
                showNotification('❌ Этот логин уже занят!', 'error');
                return;
            }

            const newAdmin = {
                username: login,
                password: password,
                role: role,
                isOnline: false,
                registeredAt: new Date().toISOString(),
                lastLogin: null,
                rating: 0,
                ratingCount: 0,
                email: '',
                displayName: login,
                avatar: ''
            };

            users.push(newAdmin);
            await saveData(users, 'users');

            document.getElementById('newAdminLogin').value = '';
            document.getElementById('newAdminPassword').value = '';
            
            showNotification(`✅ ${role} "${login}" создан!`, 'success');
            
            updateStats();
            loadUsersTable();
        }

        async function changeUserRole(username, newRole) {
            if (!confirm(`Вы уверены, что хотите изменить роль пользователя ${username} на "${newRole}"?`)) {
                loadUsersTable();
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex !== -1) {
                users[userIndex].role = newRole;
                await saveData(users, 'users');
                
                showNotification(`✅ Роль пользователя ${username} изменена на "${newRole}"!`, 'success');
                
                loadUsersTable();
                updateStats();
            }
        }

        async function deleteUser(username) {
            if (username === currentUser.username) {
                showNotification('❌ Нельзя удалить самого себя!', 'error');
                return;
            }

            if (!confirm(`Вы уверены, что хотите удалить пользователя ${username}?`)) {
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const updatedUsers = users.filter(u => u.username !== username);
            await saveData(updatedUsers, 'users');
            
            showNotification(`✅ Пользователь ${username} удален!`, 'success');
            
            updateStats();
            loadUsersTable();
        }

        async function sendTechNotification() {
            if (!['Владелец', 'Совладелец'].includes(currentUser.role)) {
                showNotification('❌ Только владелец и совладелец могут отправлять технические уведомления!', 'error');
                return;
            }

            const message = document.getElementById('techNotificationInput').value.trim();
            if (!message) {
                showNotification('❌ Введите сообщение уведомления!', 'error');
                return;
            }

            const notifications = JSON.parse(localStorage.getItem('techNotifications')) || [];
            const newNotification = {
                id: Date.now(),
                message: message,
                timestamp: new Date().toISOString(),
                sender: currentUser.username
            };

            notifications.unshift(newNotification);
            if (notifications.length > 50) notifications.length = 50;
            
            await saveData(notifications, 'techNotifications');
            
            document.getElementById('techNotificationInput').value = '';
            showNotification('✅ Техническое уведомление отправлено!', 'success');
            loadTechNotifications();
        }

        async function updateProfileFromSettings() {
            const newUsername = document.getElementById('settingsUsername').value.trim();
            const newEmail = document.getElementById('settingsEmail').value.trim();

            if (!newUsername) {
                showNotification('❌ Имя пользователя не может быть пустым!', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users'));
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex !== -1) {
                if (newUsername !== currentUser.username && users.find(u => u.username === newUsername)) {
                    showNotification('❌ Это имя пользователя уже занято!', 'error');
                    return;
                }
                
                users[userIndex].displayName = newUsername;
                users[userIndex].email = newEmail;
                
                if (newUsername !== currentUser.username) {
                    users[userIndex].username = newUsername;
                    
                    const activeUser = JSON.parse(localStorage.getItem('activeUser'));
                    activeUser.username = newUsername;
                    localStorage.setItem('activeUser', JSON.stringify(activeUser));
                    
                    currentUser.username = newUsername;
                }
                
                await saveData(users, 'users');
                currentUser = users[userIndex];
                
                showNotification('✅ Профиль успешно обновлен!', 'success');
                
                updateSettingsProfile();
                document.getElementById('currentUserInfo').textContent = 
                    `${currentUser.displayName} | ${currentUser.role}`;
            }
        }

        // ОСТАЛЬНЫЕ ФУНКЦИИ ОСТАЮТСЯ ПРЕЖНИМИ
        // ... весь ваш JavaScript код ...

        // Добавляем кнопку принудительной синхронизации
        function addSyncButton() {
            const headerActions = document.querySelector('.header-actions');
            if (headerActions && !document.getElementById('syncBtn')) {
                const syncBtn = document.createElement('button');
                syncBtn.id = 'syncBtn';
                syncBtn.className = 'btn btn-success';
                syncBtn.innerHTML = '🔄 Синхронизировать';
                syncBtn.onclick = forceSync;
                syncBtn.style.marginLeft = '10px';
                headerActions.appendChild(syncBtn);
            }
        }

        async function forceSync() {
            showNotification('🔄 Синхронизация...', 'info');
            try {
                await initDatabase();
                showNotification('✅ Данные синхронизированы!', 'success');
                
                // Обновляем интерфейс
                if (currentUser) {
                    if (currentUser.role === 'user') {
                        loadUserChatsList();
                    } else {
                        updateStats();
                        loadUsersTable();
                        loadChatsList();
                    }
                }
            } catch (error) {
                showNotification('❌ Ошибка синхронизации', 'error');
            }
        }

        // Инициализация при загрузке
        window.onload = init;
    </script>
</body>
</html>
